#!/usr/bin/env python3
# -*- coding: utf-8 -*-

#**********************************************************************************
#*                                                                                *
#*                                   Silk Fontend                                 *
#*          ------------------------------------------------------------          *
#*                                                                                *
#**********************************************************************************
#
# Copyright 2025 Antonio Leal, Porto Salvo, Portugal
# All rights reserved.
#
# Redistribution and use of this script, with or without modification, is
# permitted provided that the following conditions are met:
#
# 1. Redistributions of this script must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
#
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR IMPLIED
#  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
#  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO
#  EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
#  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
#  OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
#  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
#  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# $Id:$

import sys
import os
import subprocess
import configparser

VERSION = '20251101_00c98fa'

def usage():
    print ("Silk is a practical frontend to various slackware package management tools,")
    print ("namely slapt-get, slapt-src, sbopkg and slackpkg.")
    print ("")
    print ("Usage: silk command [options] [programs]")
    print ("")
    print ("commands:")
    print ("    u, update                    retrieve pkg data from MIRROR *and* update local cache of remote slackbuilds ")
    print ("    U, upgrade                   upgrade installed pkgs *and* upgrade all installed slackbuilds")
    print ("    s, search                    search stuff")
    print ("    b, build   [programs]        download package *and* build a slackbuild ")
    print ("    i, install [programs]        install package *and* install a slackbuild ")
    print ("    c, clean                     clean caches")
    print ("    r, remove  [programs]        remove programs")
    print ("    l, list                      list available programs")
    print ("")
    print ("where [programs] is a list of space separated package names")
    print ("")
    print ("options:")
    print ("    -y                           do not prompt for install/upgrade, assume yes")
    print ("")
    print ("The program defines the symlinks 'sl' and 'slapt' pointing to the 'silk' executable. Use them as aliases.")
    print ("Please also check ~/.config/silkrc settings to decide which ones you want to run.")

def execute(lines):
    #print(lines)
    with open('/tmp/silk', 'w') as file:
        file.writelines(lines)
    os.system('chmod +x /tmp/silk')
    subprocess.call('/tmp/silk')

def slapt_get(command, options, programs=""):
    localops = ''
    localcmd = ''
    if command in ['u', 'update']:
        localcmd = '-u'
    if command in ['U', 'upgrade']:
        localcmd = '--upgrade'
    if command in ['s', 'search']:
        localcmd = '--search'
    if command in ['b', 'build']:
        localcmd = '-d --install'
    if command in ['i', 'install']:
        localcmd = '--install'
    if command in ['c', 'clean']:
        localcmd = '--clean'
    if command in ['r', 'remove']:
        localcmd = '--remove'
    if command in ['l', 'list']:
        localcmd = '--available'
    for op in options.split():
        if op == '-y':
            localops = localops + "-y "
    localops = localops.strip()
    if localcmd != "":
        print(f'++++ Running sudo /usr/sbin/slapt-get {localops} {localcmd} {programs}\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/sbin/slapt-get {localops} {localcmd} {programs}\n']
        execute(lines)
    else:
        usage()
        exit(0)

def slapt_src(command, options, programs=""):
    localops = ''
    localcmd = ''
    if command in ['u', 'update']:
        localcmd = '-u'
    if command in ['U', 'upgrade']:
        localcmd = '--upgrade-all'
    if command in ['s', 'search']:
        localcmd = '--search'
    if command in ['b', 'build']:
        localcmd = '--build'
    if command in ['i', 'install']:
        localcmd = '--install'
    if command in ['c', 'clean']:
        localcmd = '--clean'
    if command in ['r', 'remove']:
        return
    if command in ['l', 'list']:
        localcmd = '--list'
    for op in options.split():
        if op == '-y':
            localops = localops + "-y "
    localops = localops.strip()
    if localcmd != "":
        print(f'++++ Running sudo /usr/bin/slapt-src {localops} {localcmd} {programs}\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/bin/slapt-src {localops} {localcmd} {programs}\n']
        execute(lines)
    else:
        usage()
        exit(0)

def sbopkg(command, programs=""):
    if command in ['u', 'update']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -r\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/sbin/sbopkg -r\n']
        execute(lines)
    elif command in ['U', 'upgrade']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -c\n')
        lines = ['#!/bin/bash\n\n',
                 f'sudo /usr/sbin/sbopkg -c | sudo tee /tmp/silkout \n',
                 'cat /tmp/silkout | egrep ":$" | cut -d":" -f1 | tr \"\\n\" \" \" > /tmp/silktmp\n',
                 f'sudo /usr/sbin/sbopkg -i "`cat /tmp/silktmp`"\n']
        execute(lines)
    elif command in ['s', 'search']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -g "{programs}"\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/sbin/sbopkg -g "{programs}"\n']
        execute(lines)
    elif command in ['b', 'build']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -b "{programs}"\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/sbin/sbopkg -b "{programs}"\n']
        execute(lines)
    elif command in ['i', 'install']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -i "{programs}"\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/sbin/sbopkg -i "{programs}"\n']
        execute(lines)
    elif command in ['c', 'clean']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -o\n')
        print(f'++++ Running sudo /usr/sbin/sbopkg -P\n')
        lines = ['#!/bin/bash\n\n',
                 f'sudo /usr/sbin/sbopkg -o\n',
                 f'sudo /usr/sbin/sbopkg -P\n']
        execute(lines)
    elif command in ['r', 'remove']:
        lines = ['#!/bin/bash\n\n']
        for pkg in programs.split():
            print(f'++++ Running sudo sbin/removepkg {pkg}\n')
            lines.append(f'sudo /sbin/removepkg {pkg}\n')
        execute(lines)
    elif command in ['l', 'list']:
        print(f'++++ Running sudo /usr/sbin/sbopkg -p | cat\n')
        lines = ['#!/bin/bash\n\n',
                 f'sudo /usr/sbin/sbopkg -p | cat\n']
        execute(lines)
    else:
        usage()
        exit(0)

def slackpkg(command, programs=""):
    if command in ['u', 'update']:
        print(f'++++ Running sudo /usr/sbin/slackpkg update\n')
        lines = ['#!/bin/bash\n\n', f'sudo /usr/sbin/slackpkg update\n']
        execute(lines)
    elif command in ['U', 'upgrade']:
        print(f'++++ Running sudo /usr/sbin/slackpkg install-new\n')
        print(f'++++ Running sudo /usr/sbin/slackpkg upgrade-all\n')
        lines = ['#!/bin/bash\n\n',
                 f'sudo /usr/sbin/slackpkg install-new\n',
                 f'sudo /usr/sbin/slackpkg upgrade-all\n']
        execute(lines)
    elif command in ['s', 'search']:
        lines = ['#!/bin/bash\n\n']
        for pkg in programs.split():
            print(f'++++ Running sudo /usr/sbin/slackpkg search {pkg}\n')
            lines.append(f'sudo /usr/sbin/slackpkg search {pkg}\n')
        execute(lines)
    elif command in ['b', 'build']:
        lines = ['#!/bin/bash\n\n']
        for pkg in programs.split():
            print(f'++++ Running sudo /usr/sbin/slackpkg download {pkg}\n')
            lines.append(f'sudo /usr/sbin/slackpkg download {pkg}\n')
        execute(lines)
    elif command in ['i', 'install']:
        lines = ['#!/bin/bash\n\n']
        for pkg in programs.split():
            print(f'++++ Running sudo /usr/sbin/slackpkg install {pkg}\n')
            lines.append(f'sudo /usr/sbin/slackpkg install {pkg}\n')
        execute(lines)
    elif command in ['c', 'clean']:
        print(f'++++ Running sudo /usr/sbin/slackpkg clean-system\n')
        lines = ['#!/bin/bash\n\n',
                 f'sudo /usr/sbin/slackpkg clean-system\n']
        execute(lines)
    elif command in ['r', 'remove']:
        lines = ['#!/bin/bash\n\n']
        for pkg in programs.split():
            print(f'++++ Running sudo sbin/removepkg {pkg}\n')
            lines.append(f'sudo /sbin/removepkg {pkg}\n')
        execute(lines)
    elif command in ['l', 'list']:
        print(f'++++ Running sudo rm /etc/slackpkg/templates/silk.template\n')
        print(f'++++ Running sudo /usr/sbin/slackpkg generate-template silk\n')
        print(f'++++ Running cat /etc/slackpkg/templates/silk.template\n')
        lines = ['#!/bin/bash\n\n',
                 'sudo rm /etc/slackpkg/templates/silk.template\n',
                 'sudo /usr/sbin/slackpkg generate-template silk\n',
                 'cat /etc/slackpkg/templates/silk.template\n',]
        execute(lines)
    else:
        usage()
        exit(0)

def loadconfig():
    home = os.path.expanduser('~')
    rc = f'{home}/.config/silkrc'
    config = configparser.ConfigParser()
    createfile=False
    if os.path.isfile(rc):
        config.read(rc)
        if (config.get('settings','version') != VERSION):
            createfile = True
        else:
            print(f'Loaded {home}/.config/silkrc')
    else:
        createfile = True
    if createfile:
        print(f'\nNew {home}/.config/silkrc config file is invalid/older, creating a new one...')
        with open(f'{home}/.config/silkrc', 'w') as file:
            file.writelines('[settings]\n')
            file.writelines('version = ' + str(VERSION) + '\n\n')
            file.writelines('slapt-get = true\n')
            file.writelines('slapt-src = true\n')
            file.writelines('sbopkg = false\n')
            file.writelines('slackpkg = false\n')

def main():
    loadconfig()
    home = os.path.expanduser('~')
    rc = f'{home}/.config/silkrc'
    config = configparser.ConfigParser()
    config.read(rc)

    print()
    if (len(sys.argv[1:]) == 0):
        usage()
    else:
        command = sys.argv[1]
        options = ""
        programs = ""
        for arg in sys.argv[2:]:
            if arg[0] == '-':
                options=options + " " + arg
            else:
                programs = programs + " " + arg

        if bool(config.getboolean('settings','slapt-get')):
            slapt_get(command, options, programs)
            print()
        if bool(config.getboolean('settings','slapt-src')):
            slapt_src(command, options, programs)
            print()
        if bool(config.getboolean('settings','sbopkg')):
            sbopkg(command, programs)
            print()
        if bool(config.getboolean('settings','slackpkg')):
            slackpkg(command, programs)
            print()

if __name__ == '__main__':
    main()
